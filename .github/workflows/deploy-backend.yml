name: Deploy Backend to Home Server

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Deploy to Backend Server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BACKEND_HOST }}
          username: ${{ secrets.BACKEND_USER }}
          password: ${{ secrets.BACKEND_PASSWORD }}
          port: 22
          script: |
            cd domino-dashboard

            echo "ğŸ“¥ Atualizando cÃ³digo do repositÃ³rio..."
            git pull origin main

            echo "ğŸ›‘ Parando container..."
            docker stop dashboard-backend 2>/dev/null || true
            docker rm dashboard-backend 2>/dev/null || true

            echo "ğŸ”¨ Reconstruindo imagem..."
            docker build -t pedropunx/domino-tech-backend:latest ./backend

            echo "ğŸš€ Iniciando container..."
            docker compose up -d backend

            echo "â³ Aguardando 15 segundos..."
            sleep 15

            echo "âœ… Status do container:"
            docker compose ps

            echo "ğŸ¥ Health check:"
            curl -s http://localhost:3001/api/health || echo "Aguardando..."

            echo "ğŸ“‹ Logs:"
            docker compose logs --tail 20 backend
